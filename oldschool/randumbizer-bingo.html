<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bingo Overlap Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #020307 0%, #000000ee 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            justify-content: center;
        }

        .nav-btn {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .nav-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: #764ba2;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .player-btn {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
        }

        .player-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .player-name {
            font-size: 18px;
        }

        .player-score {
            font-size: 24px;
            color: #ffd700;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
        }

        .error {
            background: #fee;
            border: 2px solid #fcc;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            color: #c00;
        }

        .info {
            background: #e7f3ff;
            border: 2px solid #b3d9ff;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            color: #004085;
        }

        .player-detail {
            margin-top: 30px;
        }

        .back-btn {
            padding: 10px 20px;
            background: #666;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .back-btn:hover {
            background: #555;
        }

        .score-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 30px;
            border-radius: 15px;
            color: white;
            text-align: center;
            margin: 20px 0;
        }

        .score-card h2 {
            font-size: 3em;
            margin: 10px 0;
        }

        .bingo-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin: 20px 0;
            max-width: 600px;
        }

        .bingo-cell {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #dee2e6;
        }

        .bingo-cell.shared {
            background: #d4edda;
            border-color: #28a745;
            font-weight: bold;
        }

        .overlap-list {
            margin: 20px 0;
        }

        .overlap-item {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .leaderboard {
            margin-top: 20px;
        }

        .leaderboard-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            margin: 10px 0;
            border-radius: 10px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 18px;
        }

        .rank {
            font-size: 24px;
            font-weight: bold;
            width: 40px;
        }

        .load-btn {
            padding: 15px 30px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            margin: 20px auto;
            display: block;
        }

        .load-btn:hover {
            background: #218838;
        }

        .status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 6px;
            font-weight: bold;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üéØ Bingo Overlap Tracker</h1>

        <div class="nav-buttons">
            <button class="nav-btn active" onclick="showPage('players')">Players</button>
            <button class="nav-btn" onclick="showPage('leaderboard')">Leaderboard</button>
            <button class="nav-btn" onclick="showPage('loserboard')">Loserboard</button>
        </div>

        <div id="players-page" class="page active">
            <div id="players-content">
                <div class="loading">Loading...</div>
            </div>
        </div>

        <div id="leaderboard-page" class="page">
            <div id="leaderboard-content">
                <div class="loading">Load player data first</div>
            </div>
        </div>

        <div id="loserboard-page" class="page">
            <div id="loserboard-content">
                <div class="loading">Load player data first</div>
            </div>
        </div>

        <div id="detail-page" class="page">
            <button class="back-btn" onclick="showPage('players')">‚Üê Back to Players</button>
            <div id="detail-content"></div>
        </div>
    </div>

    <script>
        let playersData = [];

        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

            if (pageName === 'detail') {
                document.getElementById('detail-page').classList.add('active');
            } else {
                document.getElementById(pageName + '-page').classList.add('active');
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    if (btn.textContent.toLowerCase().includes(pageName)) {
                        btn.classList.add('active');
                    }
                });
            }
        }

        const MASTER_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTgvwJt-h0tT6LNx4szir2eKypPkTSp6ZflYPJKMIH7xsD9_Ab5TUvUEibfCAuYB1892ITLTgTYfUop/pub?output=csv';

        async function fetchPlayersFromMasterSheet() {
            try {
                const response = await fetch(MASTER_SHEET_URL);
                const csvText = await response.text();

                const lines = csvText.split('\n');
                const players = [];

                // Skip header row (if exists), start from row 1
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    const cells = parseCSVLine(line);
                    const username = cells[0]?.trim();

                    if (!username) continue;

                    // Extract items from columns C-AL (index 2-37)
                    const items = [];
                    for (let j = 2; j < 38 && j < cells.length; j++) {
                        const item = cells[j]?.trim();
                        if (item) items.push(item);
                    }

                    if (items.length > 0) {
                        players.push({
                            username: username,
                            items: items
                        });
                    }
                }

                return players;
            } catch (error) {
                console.error('Error fetching master sheet:', error);
                return [];
            }
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);

            return result;
        }

        async function loadAllData() {
            const content = document.getElementById('players-content');
            content.innerHTML = '<div class="loading">Loading player data from master sheet...</div>';

            playersData = await fetchPlayersFromMasterSheet();

            if (playersData.length > 0) {
                calculateOverlaps();
                renderPlayers();
                renderLeaderboard();
                renderLoserboard();
            } else {
                content.innerHTML = '<div class="error">Failed to load player data. Make sure the sheet is published to web.</div>';
            }
        }

        function calculateOverlaps() {
            playersData.forEach(player => {
                let totalOverlap = 0;
                let overlaps = {};

                playersData.forEach(other => {
                    if (player.username === other.username) return;

                    const shared = player.items.filter(item =>
                        other.items.includes(item)
                    );

                    if (shared.length > 0) {
                        overlaps[other.username] = shared.length;
                        totalOverlap += shared.length;
                    }
                });

                player.overlapScore = totalOverlap;
                player.overlaps = overlaps;
            });
        }

        function renderPlayers() {
            const content = document.getElementById('players-content');

            if (playersData.length === 0) {
                content.innerHTML = '<div class="loading">No players loaded yet</div>';
                return;
            }

            content.innerHTML = `
                <div class="players-grid">
                    ${playersData.map(player => `
                        <button class="player-btn" onclick="showPlayerDetail('${player.username}')">
                            <span class="player-name">${player.username}</span>
                            <span class="player-score">${player.overlapScore || 0}</span>
                        </button>
                    `).join('')}
                </div>
            `;
        }

        // Auto-load data on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadAllData();
        });

        function showPlayerDetail(username) {
            const player = playersData.find(p => p.username === username);
            if (!player) return;

            const allItems = new Set();
            playersData.forEach(p => p.items.forEach(item => allItems.add(item)));
            const sharedItemCounts = {};

            player.items.forEach(item => {
                const matches = playersData.filter(p =>
                    p.username !== player.username && p.items.includes(item)
                ).length;

                if (matches > 0) {
                    sharedItemCounts[item] = matches;
                }
            });

            const content = document.getElementById('detail-content');
            content.innerHTML = `
                <h2>${player.username}'s Board</h2>
                
                <div class="score-card">
                    <h3>Overlap Score</h3>
                    <h2>${player.overlapScore}</h2>
                </div>

                <h3>Your Bingo Board</h3>
                <div class="bingo-grid">
                    ${player.items.map(item => {
                const count = sharedItemCounts[item] || 0;
                return `
                            <div class="bingo-cell ${count > 0 ? 'shared' : ''}">
                                ${item}${count > 0 ? ` (+${count})` : ''}
                            </div>
                        `;
            }).join('')}
                </div>

            `;

            showPage('detail');
        }

        function renderLeaderboard() {
            const content = document.getElementById('leaderboard-content');

            if (playersData.length === 0) {
                content.innerHTML = '<div class="loading">No data loaded yet</div>';
                return;
            }

            const sorted = [...playersData].sort((a, b) => b.overlapScore - a.overlapScore);
            const top10 = sorted.slice(0, 10);

            content.innerHTML = `
                <h2>Top 10 Overlap Scores</h2>
                <div class="leaderboard">
                    ${top10.map((player, idx) => `
                        <div class="leaderboard-item">
                            <div style="display: flex; align-items: center; gap: 20px;">
                                <span class="rank">#${idx + 1}</span>
                                <span style="font-size: 20px;">${player.username}</span>
                            </div>
                            <span style="font-size: 24px; font-weight: bold;">${player.overlapScore}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderLoserboard() {
            const content = document.getElementById('loserboard-content');

            if (playersData.length === 0) {
                content.innerHTML = '<div class="loading">No data loaded yet</div>';
                return;
            }

            const sorted = [...playersData].sort((a, b) => b.overlapScore - a.overlapScore).reverse();
            const top10 = sorted.slice(0, 10);

            content.innerHTML = `
                <h2>Bottom 10 Overlap Scores</h2>
                <div class="leaderboard">
                    ${top10.map((player, idx) => `
                        <div class="leaderboard-item">
                            <div style="display: flex; align-items: center; gap: 20px;">
                                <span class="rank">#${idx + 1}</span>
                                <span style="font-size: 20px;">${player.username}</span>
                            </div>
                            <span style="font-size: 24px; font-weight: bold;">${player.overlapScore}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }
    </script>
</body>

</html>